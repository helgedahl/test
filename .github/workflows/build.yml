name: release
on: workflow_dispatch

env:
  DOCKER_REGISTRY: docker.pkg.github.com
  #DOCKER_REGISTRY: ghcr.io
  GITHUB_PACKAGE: another-package

jobs:
  docker-build:
    runs-on: ubuntu-latest
    steps:
      - name: Echo
        run: echo ${DOCKER_REGISTRY}
      - name: Echo2
        run: echo ${GITHUB_ACTOR}
      - uses: azure/docker-login@v1
        # this logs us into GitHub Packages (docker service)
        with:
          login-server: docker.pkg.github.com
          # login-server: ghcr.io
          username: ${GITHUB_ACTOR}
          password: ${{ secrets.GITHUB_TOKEN }}
      #- uses: docker/login-action@v2
      #  with:
      #    registry: ghcr.io
      #    username: ${GITHUB_ACTOR}
      #    password: ${{ secrets.PAT }}
      - name: Pull a known image
        run: docker pull debian:buster-slim
      - name: Re-tag that image
        run: docker image tag debian:buster-slim ${DOCKER_REGISTRY}/${{ github.repository }}/${GITHUB_PACKAGE}:123459
      - name: Push that image
        run: docker push ${DOCKER_REGISTRY}/${{ github.repository }}/${GITHUB_PACKAGE}:123459
      - name: Dispatch release
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.PAT_BEARER }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/helgedahl/test2/dispatches \
            -d '{"event_type":"package_published","client_payload":{"package":"another-package"}}'
      
